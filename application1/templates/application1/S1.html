<!DOCTYPE html>
{% load static %}
<html>
<head>
  <title>Speech App</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'application1/CSS/index.css' %}">
</head>
<body class="background">
    <div class="jumbotron" style="border-radius: 20px;">
        <marquee behavior="" direction="" style="color:blue">It is developed By Vinay Relangi using Python Modules..</marquee>
  <h2>üîä Text to Speech</h2>
  <form method="post">
    {% csrf_token %}
    <input type="text" name="text" placeholder="Enter text here">
    <button type="submit">Convert to Audio</button>
  </form>

  {% if audio_file %}
    <p>‚úÖ Audio generated:</p>
    <audio controls>
      <source src="{{ audio_file }}" type="audio/mp3">
    </audio>
  {% endif %}

  <hr>

  <h2>üéôÔ∏è Speech to Text</h2>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <p><b>Converted Text:</b> <span id="result"></span></p>
  </div>

  <script>
    // üîπ Function to get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    let mediaRecorder;
    let audioChunks = [];

    document.getElementById("startBtn").onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();

      audioChunks = [];
      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    };

    document.getElementById("stopBtn").onclick = () => {
      mediaRecorder.stop();

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "recording.wav");

        // üîπ Send CSRF token in request headers
        const response = await fetch("{% url 'test_case2' %}", {
          method: "POST",
          body: formData,
          headers: { "X-CSRFToken": csrftoken }
        });

        const data = await response.json();
        document.getElementById("result").innerText = data.text;

        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
      };
    };
  </script>
</body>
</html>
